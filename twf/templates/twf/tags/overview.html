{% extends 'twf/base/base.html' %}
{% load nav_tags %}

{% block content %}
    <p class="lead">Overview of tag extraction and grouping status across your project.</p>

    {% include 'twf/tags/info_card_tags.html' %}

    <h2>Tag Grouping Status</h2>
    <div class="table-responsive"> <!-- Responsive table wrapper -->
        <table class="table table-borderless align-middle">
            <thead class="table-light">
                <tr>
                    <th data-bs-toggle="tooltip" data-bs-placement="top"
                        title="The type of tag extracted from your documents (e.g., person names, place names, dates)">
                        Variation Type <i class="fas fa-info-circle text-muted"></i>
                    </th>
                    <th data-bs-toggle="tooltip" data-bs-placement="top"
                        title="Dictionary type this tag type is mapped to (if different from tag type)">
                        Dict Type <i class="fas fa-info-circle text-muted"></i>
                    </th>
                    <th data-bs-toggle="tooltip" data-bs-placement="top"
                        title="Processing workflow: Group (assign to dictionary), Enrich (direct enrichment), or Ignore (excluded from processing)">
                        Workflow <i class="fas fa-info-circle text-muted"></i>
                    </th>
                    <th class="text-end" data-bs-toggle="tooltip" data-bs-placement="top"
                        title="Total number of tags of this type across all documents">
                        Total Count <i class="fas fa-info-circle text-muted"></i>
                    </th>
                    <th data-bs-toggle="tooltip" data-bs-placement="top"
                        title="Percentage of this tag type relative to all tags in the project">
                        Percentage <i class="fas fa-info-circle text-muted"></i>
                    </th>
                    <th class="text-end" data-bs-toggle="tooltip" data-bs-placement="top"
                        title="Number of tags processed: assigned to dictionary entries (grouping) or enriched with normalized data (enrichment)">
                        Processed <i class="fas fa-info-circle text-muted"></i>
                    </th>
                    <th data-bs-toggle="tooltip" data-bs-placement="top"
                        title="Percentage of tags that have been successfully processed">
                        Processed % <i class="fas fa-info-circle text-muted"></i>
                    </th>
                    <th class="text-end" data-bs-toggle="tooltip" data-bs-placement="top"
                        title="Number of tags temporarily set aside for later processing">
                        Parked <i class="fas fa-info-circle text-muted"></i>
                    </th>
                    <th data-bs-toggle="tooltip" data-bs-placement="top"
                        title="Percentage of tags that have been parked">
                        Parked % <i class="fas fa-info-circle text-muted"></i>
                    </th>
                    <th class="text-end" data-bs-toggle="tooltip" data-bs-placement="top"
                        title="Number of tags not yet processed (grouped/enriched) or parked, requiring attention">
                        Unresolved <i class="fas fa-info-circle text-muted"></i>
                    </th>
                    <th data-bs-toggle="tooltip" data-bs-placement="top"
                        title="Percentage of tags that remain unresolved">
                        Unresolved % <i class="fas fa-info-circle text-muted"></i>
                    </th>
                </tr>
            </thead>
            <tbody>
            {% for variation in stats.variation_type_edit_counts %}
                <tr>
                    <td>{{ variation.variation_type }}</td>
                    <td>
                        {% if variation.dict_type %}
                            <span class="badge bg-info" data-bs-toggle="tooltip"
                                  title="Tag type '{{ variation.variation_type }}' is mapped to dictionary type '{{ variation.dict_type }}'">
                                {{ variation.dict_type }}
                            </span>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        {% if variation.workflow_type == "group" %}
                            <span class="badge bg-primary" data-bs-toggle="tooltip"
                                  title="Tags are assigned to dictionary entries">
                                <i class="fas fa-object-group me-1"></i>Group
                            </span>
                        {% elif variation.workflow_type == "enrich" %}
                            <span class="badge bg-success" data-bs-toggle="tooltip"
                                  title="Tags use direct enrichment workflow">
                                <i class="fas fa-plus-circle me-1"></i>Enrich
                            </span>
                        {% elif variation.workflow_type == "ignore" %}
                            <span class="badge bg-secondary" data-bs-toggle="tooltip"
                                  title="Tags are excluded from processing">
                                <i class="fas fa-ban me-1"></i>Ignore
                            </span>
                        {% endif %}
                    </td>
                    <td class="text-end">{{ variation.count }}</td>
                    <!-- Pie chart for the "Percentage" column -->
                    <td class="d-flex align-items-center">
                        <svg width="24" height="24" viewBox="0 0 36 36" class="me-2">
                            <circle cx="18" cy="18" r="16" fill="none" stroke="#e9ecef" stroke-width="4"></circle>
                            <circle cx="18" cy="18" r="16" fill="none" stroke="blue" stroke-width="4"
                                    stroke-dasharray="{{ variation.percentage }} 100"
                                    transform="rotate(-90 18 18)">
                            </circle>
                        </svg>
                        {{ variation.percentage|floatformat:2 }}%
                    </td>
                    <!-- Progress bars for the remaining percentages -->
                    <td class="text-end">{{ variation.grouped }}</td>
                    <td>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-success" role="progressbar"
                                 style="width: {{ variation.grouped_percentage }}%;"
                                 aria-valuenow="{{ variation.grouped_percentage }}"
                                 aria-valuemin="0" aria-valuemax="100">
                                {{ variation.grouped_percentage|floatformat:2 }}%
                            </div>
                        </div>
                    </td>
                    <td class="text-end">{{ variation.parked }}</td>
                    <td>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-warning" role="progressbar"
                                 style="width: {{ variation.parked_percentage }}%;"
                                 aria-valuenow="{{ variation.parked_percentage }}"
                                 aria-valuemin="0" aria-valuemax="100">
                                {{ variation.parked_percentage|floatformat:2 }}%
                            </div>
                        </div>
                    </td>
                    <td class="text-end">{{ variation.unresolved }}</td>
                    <td>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-danger" role="progressbar"
                                 style="width: {{ variation.unresolved_percentage }}%;"
                                 aria-valuenow="{{ variation.unresolved_percentage }}"
                                 aria-valuemin="0" aria-valuemax="100">
                                {{ variation.unresolved_percentage|floatformat:2 }}%
                            </div>
                        </div>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    {% if stats.has_ignored_tags %}
        <h2 class="mt-5">
            <i class="fas fa-ban me-2 text-secondary"></i>Ignored Tag Types
        </h2>
        <p class="text-muted">These tag types are configured as ignored in Task Settings and are excluded from workflows</p>
        <div class="table-responsive">
            <table class="table table-borderless align-middle">
                <thead class="table-secondary">
                    <tr>
                        <th data-bs-toggle="tooltip" data-bs-placement="top"
                            title="The type of tag extracted from your documents">
                            Variation Type <i class="fas fa-info-circle text-muted"></i>
                        </th>
                        <th data-bs-toggle="tooltip" data-bs-placement="top"
                            title="Dictionary type this tag type is mapped to (if different from tag type)">
                            Dict Type <i class="fas fa-info-circle text-muted"></i>
                        </th>
                        <th data-bs-toggle="tooltip" data-bs-placement="top"
                            title="Processing workflow: Group (assign to dictionary), Enrich (direct enrichment), or Ignore (excluded from processing)">
                            Workflow <i class="fas fa-info-circle text-muted"></i>
                        </th>
                        <th class="text-end" data-bs-toggle="tooltip" data-bs-placement="top"
                            title="Total number of tags of this type across all documents">
                            Total Count <i class="fas fa-info-circle text-muted"></i>
                        </th>
                        <th data-bs-toggle="tooltip" data-bs-placement="top"
                            title="Percentage of this tag type relative to all tags in the project">
                            Percentage <i class="fas fa-info-circle text-muted"></i>
                        </th>
                    </tr>
                </thead>
                <tbody>
                {% for variation in stats.ignored_variation_type_counts %}
                    <tr>
                        <td>{{ variation.variation_type }}</td>
                        <td>
                            {% if variation.dict_type %}
                                <span class="badge bg-info" data-bs-toggle="tooltip"
                                      title="Tag type '{{ variation.variation_type }}' is mapped to dictionary type '{{ variation.dict_type }}'">
                                    {{ variation.dict_type }}
                                </span>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            {% if variation.workflow_type == "group" %}
                                <span class="badge bg-primary" data-bs-toggle="tooltip"
                                      title="Tags are assigned to dictionary entries">
                                    <i class="fas fa-object-group me-1"></i>Group
                                </span>
                            {% elif variation.workflow_type == "enrich" %}
                                <span class="badge bg-success" data-bs-toggle="tooltip"
                                      title="Tags use direct enrichment workflow">
                                    <i class="fas fa-plus-circle me-1"></i>Enrich
                                </span>
                            {% elif variation.workflow_type == "ignore" %}
                                <span class="badge bg-secondary" data-bs-toggle="tooltip"
                                      title="Tags are excluded from processing">
                                    <i class="fas fa-ban me-1"></i>Ignore
                                </span>
                            {% endif %}
                        </td>
                        <td class="text-end">{{ variation.count }}</td>
                        <td class="d-flex align-items-center">
                            <svg width="24" height="24" viewBox="0 0 36 36" class="me-2">
                                <circle cx="18" cy="18" r="16" fill="none" stroke="#e9ecef" stroke-width="4"></circle>
                                <circle cx="18" cy="18" r="16" fill="none" stroke="#6c757d" stroke-width="4"
                                        stroke-dasharray="{{ variation.percentage }} 100"
                                        transform="rotate(-90 18 18)">
                                </circle>
                            </svg>
                            {{ variation.percentage|floatformat:2 }}%
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    {% endif %}
{% endblock %}
