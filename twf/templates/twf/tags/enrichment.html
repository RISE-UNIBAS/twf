{% extends 'twf/base/base.html' %}
{% load crispy_forms_tags %}

{% block content %}
    <p class="lead">Enrich tags with normalized data.</p>
    {% include 'twf/base/alert_info.html' %}

    {% if not has_active_workflow %}
        {# Show workflow start form when no active workflow #}
        <div class="alert alert-info">
            <h5><i class="fa fa-info-circle"></i> Start a Tag Enrichment Workflow</h5>
            <p>Select a tag type to enrich below. Enrichment types are configured in Project Settings > Task Settings > Tag Type Settings.</p>
        </div>
        {% if workflow_start_form %}
            {% crispy workflow_start_form %}
        {% else %}
            <div class="alert alert-warning">
                <strong>No enrichment types configured.</strong>
                <p>Configure enrichment types in Project Settings > Task Settings > "Enrichment Types Configuration" field.</p>
            </div>
        {% endif %}
    {% else %}
        {# Show workflow interface when workflow is active #}
        {% if workflow %}
            <div class="card mb-3">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h5 class="card-title mb-1">
                                <i class="fa fa-tags"></i> {{ workflow_title|default:"Tag Enrichment Workflow" }}
                            </h5>
                            <p class="mb-0 text-muted small">
                                Progress: {{ workflow_progress.completed }} / {{ workflow_progress.total }} tags
                                ({{ workflow_progress.percentage }}%)
                            </p>
                            <div class="progress mt-2" style="height: 20px;">
                                <div class="progress-bar bg-success" role="progressbar"
                                     style="width: {{ workflow_progress.percentage }}%"
                                     aria-valuenow="{{ workflow_progress.completed }}"
                                     aria-valuemin="0"
                                     aria-valuemax="{{ workflow_progress.total }}">
                                    {{ workflow_progress.percentage }}%
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <a href="#"
                               class="btn btn-sm btn-warning show-danger-modal"
                               data-message="Are you sure you want to cancel this workflow? All progress will be lost and reserved tags will be released."
                               data-redirect-url="{% url 'twf:celery_task_cancel' workflow.related_task.pk %}">
                                <i class="fa fa-times"></i> Cancel Workflow
                            </a>
                        </div>
                    </div>
                    {% if workflow_instructions %}
                        <div class="mt-3 alert alert-light">
                            <strong>Instructions:</strong>
                            <div>{{ workflow_instructions|safe }}</div>
                        </div>
                    {% endif %}
                </div>
            </div>
        {% endif %}

        {% if has_next_tag %}
            <div class="alert alert-light border mb-3">
                <p class="mb-2"><strong>Tag:</strong> <span class="badge bg-primary">{{ tag.variation }}</span></p>
                <p class="mb-0 small text-muted">
                    <i class="fa fa-info-circle"></i>
                    Fill in the normalized data and click "Save & Next" to continue.
                </p>
            </div>

            {% if tag.line_text %}
                <div class="card mb-3">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">
                            <i class="fa fa-quote-left me-2"></i>Context from document
                        </h6>
                        <p class="card-text">
                            {% load twf_filters %}
                            {{ tag|highlight_tag_in_context }}
                        </p>
                        <p class="card-text small text-muted mb-0">
                            <i class="fa fa-file-text me-1"></i>Page {{ tag.page.tk_page_number }}
                            | <i class="fa fa-book me-1"></i>
                            <a href="{% url 'twf:view_document' tag.page.document.pk %}" class="text-decoration-none">
                                {{ tag.page.document.title }}
                            </a>
                            | <a href="{{ tag.get_transkribus_url }}" target="_blank" class="text-decoration-none"
                                 title="Open in Transkribus">
                                <i class="fa fa-external-link me-1"></i>Transkribus
                            </a>
                        </p>
                    </div>
                </div>
            {% endif %}

            <div class="row">
                <div class="col-12">
                    {% crispy form %}
                </div>
            </div>
        {% else %}
            <div class="alert alert-info">
                There are no more tags to enrich in this workflow.
            </div>
        {% endif %}
    {% endif %} {# End has_active_workflow check #}
{% endblock %}
