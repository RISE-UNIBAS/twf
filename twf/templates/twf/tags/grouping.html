{% extends 'twf/base/base.html' %}
{% load nav_tags %}
{% load crispy_forms_tags %}

{% block content %}
    <p class="lead">Group similar tag variations into dictionary entries for consistent data.</p>

    {% if not has_active_workflow %}
        {# Show workflow start form when no active workflow #}
        <div class="alert alert-info">
            <h5><i class="fa fa-info-circle"></i> Start a Tag Grouping Workflow</h5>
            <p>Start a workflow to group tags into dictionary entries. Select a tag type and batch size below.</p>
        </div>
        {% crispy workflow_start_form %}
    {% else %}
        {# Show workflow interface when workflow is active #}
        {% if workflow %}
            <div class="card mb-3">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h5 class="card-title mb-1">
                                <i class="fa fa-tasks"></i> Tag Grouping Workflow
                                <span class="badge bg-primary">{{ selected_type|title }}</span>
                            </h5>
                            <p class="mb-0 text-muted small">
                                Progress: {{ workflow_progress.completed }} / {{ workflow_progress.total }} unique tags
                                ({{ workflow_progress.percentage }}%)
                            </p>
                            <div class="progress mt-2" style="height: 20px;">
                                <div class="progress-bar" role="progressbar"
                                     style="width: {{ workflow_progress.percentage }}%"
                                     aria-valuenow="{{ workflow_progress.completed }}"
                                     aria-valuemin="0"
                                     aria-valuemax="{{ workflow_progress.total }}">
                                    {{ workflow_progress.percentage }}%
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <a href="#"
                               class="btn btn-sm btn-warning show-danger-modal"
                               data-message="Are you sure you want to cancel this workflow? All progress will be lost and reserved tags will be released."
                               data-redirect-url="{% url 'twf:celery_task_cancel' workflow.related_task.pk %}">
                                <i class="fa fa-times"></i> Cancel Workflow
                            </a>
                        </div>
                    </div>
                    {% if workflow_instructions %}
                        <div class="mt-3 alert alert-light">
                            <strong>Instructions:</strong>
                            <div>{{ workflow_instructions|safe }}</div>
                        </div>
                    {% endif %}
                </div>
            </div>
        {% endif %}

        {%  if dictionary %}
        {% if tag %}
            <div class="my-3 p-3 border rounded" style="background-color: khaki">
                <p class="text-center" style="color: #7c7c7c">Try to group:
                    <span class="float-end">
                        <a href="{% url 'twf:tags_park' tag.id %}" class="btn btn-secondary">Park</a>
                        <a href="{% url 'twf:tags_park_all' tag.id %}" class="btn btn-warning ms-2"
                           data-bs-toggle="tooltip" title="Park all {{ identical_tag_count }} tag(s) with variation '{{ tag.variation }}'">
                            Park All Identical
                            <span class="badge bg-dark">{{ identical_tag_count }}</span>
                        </a>
                    </span>
                </p>
                <p class="display-6 text-center">{{ tag.variation }}</p>

                {% if tag.line_text %}
                    <div class="mt-3 p-2 bg-light border rounded">
                        <p class="small mb-1 text-muted"><i class="fa fa-quote-left me-2"></i>Context from document:</p>
                        <p class="mb-0 small">
                            {% load twf_filters %}
                            {{ tag|highlight_tag_in_context }}
                        </p>
                        <p class="small text-muted mb-0 mt-1">
                            <i class="fa fa-file-text me-1"></i>Page {{ tag.page.tk_page_number }}
                            | <i class="fa fa-book me-1"></i><a href="{% url 'twf:view_document' tag.page.document.pk %}" class="text-decoration-none">{{ tag.page.document.title }}</a>
                            | <a href="{{ tag.get_transkribus_url }}" target="_blank" class="text-decoration-none" title="Open in Transkribus"><i class="fa fa-external-link me-1"></i>Transkribus</a>
                        </p>
                    </div>
                {% endif %}
            </div>

            <div class="my-3 p-3 border rounded">
                <form method="post">
                    {% csrf_token %}
                    <!-- always include the tag_id and dictionary_id -->
                    <input type="hidden" name="tag_id" value="{{ tag.id }}"/>
                    <input type="hidden" name="dictionary_id" value="{{ dictionary.id }}"/>

                    <!-- display the closest entries -->
                    {% if closest %}
                        {% for close in closest %}
                            <div class="row border">
                                <div class="col-1">
                                    <span class="badge" style="background-color: {% value_to_color close.1 %}">{{ close.1 }}</span>
                                    {% if close.2 > 1 %}
                                        <span class="badge bg-success mt-1" data-bs-toggle="tooltip"
                                              title="{{ close.2 }} variations match strongly">
                                            <i class="fa fa-star"></i> {{ close.2 }}
                                        </span>
                                    {% endif %}
                                </div>
                                <div class="col-3">
                                   {{ close.0.entry }}
                                </div>
                                <div class="col-5 small">
                                    {% for var in close.0.entry.variations.all %}
                                        {% if var.variation == close.0.variation %}
                                            <b>{{ var.variation }}</b>
                                        {% else %}
                                            {{ var.variation }}
                                        {% endif %}<br/>
                                    {% endfor %}
                                </div>
                                <div class="col-3">
                                    <input type="submit" name="add_to_{{ close.0.entry.id }}" value="Add To '{{ close.0.entry }}'" class="btn btn-dark" style="width: 100%;" />
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="alert alert-info">
                            There are no similar entries. Create a new one below
                        </div>
                    {% endif %}

                    <!-- Create a new entry from the tag -->
                    <div class="row border">
                        <div class="col-1">
                            <span class="badge bg-dark mt-2">New</span>
                        </div>
                        <div class="col-3">
                            <input type="text" name="new_entry_label" class="form-control" value="{{ tag.variation }}"/>
                        </div>
                        <div class="col-5 small mt-2">
                            Create entry and add: "<i>{{ tag.variation }}</i>"
                        </div>
                        <div class="col-3">
                            <input type="submit" name="create_new" value="Create New Entry" class="btn btn-dark" style="width: 100%;" />
                        </div>
                    </div>

                    <!-- Add the tag to an existing entry -->
                    <div class="row border">
                        <div class="col-1">
                            <span class="badge bg-dark mt-2">Add</span>
                        </div>
                        <div class="col-3">
                           <select name="selected_entry" class="form-control select2" aria-label="Selected Entry">
                                <option value="">Select Entry</option>
                                {% for option in dict_entries %}
                                    <option value="{{ option.id }}">{{ option }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-5 small">
                            Select an entry an add: "<i>{{ tag.variation }}</i>"
                        </div>
                        <div class="col-3">
                            <input type="submit" name="add_to_existing" value="Add To Selected Entry" class="btn btn-dark" style="width: 100%;" />
                        </div>
                    </div>
                    <div class="row border">
                        <div class="col-1"></div>
                        <div class="col-3">
                            <div class="mb-2">
                                <label for="NotesOnEntry" class="form-label small mb-0">Notes on Entry</label>
                                <textarea id="NotesOnEntry" name="notes_on_entry" class="form-control"></textarea>
                                <div id="NotesOnEntryHelp" class="form-text">Add notes to the dictionary entry.</div>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="mb-2">
                                <label for="NotesOnVariation" class="form-label small mb-0">Notes on Variation</label>
                                <textarea id="NotesOnVariation" name="notes_on_variation" class="form-control"></textarea>
                                <div id="NotesOnEntryHelp" class="form-text">Add notes to the page tag variation.</div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        {% else %}
            <div class="alert alert-success mt-3">
                There are no more tags of this type.
            </div>
        {% endif %}
 {% else %}
        <div class="alert alert-danger mt-3">
            There is no dictionary for the selected tag type <strong>"{{ selected_dict_type }}"</strong>.
            Please <a href="{% url 'twf:dictionary_create' %}">create</a> or <a href="{% url 'twf:dictionaries_add' %}">add</a>
            a dictionary with the same type to your project, or assign your tag type
            to an existing dictionary type in the <a href="{% url 'twf:project_settings_tasks' %}?tab=tag_types">Task Settings</a>.
        </div>
 {% endif %}
    {% endif %} {# End has_active_workflow check #}
{% endblock %}

{% block script %}
    <script>
        $(document).ready(function() {
            $('.select2').select2({
                width: '100%',
                placeholder: "Select an entry",
                allowClear: true
            });
        });
    </script>
{% endblock %}
