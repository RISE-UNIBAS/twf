{% extends 'twf/base/base.html' %}
{% load static %}

{% block content %}
    <div class="border rounded bg-light mt-0 p-3">
        <h1 class="display-6">Structure downloaded data</h1>
        <p class="lead">This page allows you to extract the downloaded data 
            from Transkribus and create database objects from it.</p>
        
        {% if not project.job_download_url %}
            <div class="alert alert-warning" role="alert">
                <h4 class="alert-heading">There is no export</h4>
                <p>
                    You need to request an export and download it first.
                    Please go to the <a href="{% url 'twf:project_tk_export' %}">TK Export</a> page and
                    start an export.
                </p>
            </div>
        {% endif %}
        
        <div class="row">
            <div class="col-12">
                <div class="mb-3">
                    <label for="extractZip" class="form-label">Extract files from zip and create database objects</label>
                    
                    <input 
                            id="extractZip" 
                            type="button"  
                            role="button" 
                            class="form-control btn btn-dark show-confirm-modal" 
                            value="Extract Downloaded Data"
                            data-message="Are you sure you want to extract the downloaded data? This may take a while.">
                    
                    <div id="transkribusDownloadHelp" class="form-text text-danger">
                        Depending on the number of your documents, this can take a long time.
                    </div>
                    
                    <div class="col-12 border text-center">
                        <span>Progress:</span>
                        <div class="progress">
                            <div class="progress-bar bg-dark" role="progressbar" 
                                 style="width: 0;" id="extractProgressBar" aria-valuenow="0" 
                                 aria-valuemin="0" aria-valuemax="100">0%</div>
                        </div>
                    </div>
                    
                    <div class="col-12">
                        <textarea id="extractionLog" style="width: 100%" rows="10"></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block script %}
    <script src="{% static 'twf/js/celery_task_monitor.js' %}"></script>
    <script>
        $(document).ready(function () {
          // Initialize the modal
          const normalModal = new bootstrap.Modal($('#confirmModal')[0]);
          const normalConfirmButton = $('#confirmActionButton');
        
          let taskData = null; // Data to pass to the task
          let startTaskFunction = null; // Function to execute on confirmation
        
          // Attach click event to buttons with 'show-confirm-modal' class
          $('.show-confirm-modal').on('click', function (event) {
            event.preventDefault(); // Prevent default behavior
        
            // Set modal message dynamically
            const message = $(this).data('message');
            $('#confirmModal .modal-body').text(message);
        
            // Store the task function for confirmation
            startTaskFunction = () => {
              const startUrl = '/celery/transkribus/extract/'; // Task start URL
              const progressUrlBase = '/celery/status/'; // Base URL for polling progress
              const progressBarId = '#extractProgressBar'; // ID of the progress bar element
              const logTextareaId = '#extractionLog'; // ID of the textarea to display logs
        
              // Start the task
              startTask(startUrl, progressUrlBase, progressBarId, logTextareaId);
            };
        
            // Show the modal
            normalModal.show();
          });
        
          // Handle confirmation
          normalConfirmButton.on('click', function () {
            if (startTaskFunction) {
              startTaskFunction(); // Execute the stored function
            }
        
            // Hide the modal
            normalModal.hide();
          });
          
        });
    </script>
{% endblock %}