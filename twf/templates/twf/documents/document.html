{% extends 'twf/base/base.html' %}
{% load static %}
{% load nav_tags %}
{% load twf_renders %}

{% block content %}
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Document Details</h5>
                    <table class="table">
                        <tr>
                            <td>Database ID / Transkribus ID</td>
                            <td> {{ document.pk }} / {{ document.document_id }}</td>
                        </tr>
                        <tr>
                            <td>Object data</td>
                            <td>
                                Created at {{ document.created_at }} by {{ document.created_by }}.
                                Last updated by {{ document.modified_by }} at {{ document.modified_at }}.
                            </td>
                        </tr>
                        <tr>
                            <td>Document Title</td>
                            <td> {{ document.title }}</td>
                        </tr>
                        <tr>
                            <td>Tags in the document</td>
                            <td>
                                {% for page in document.pages.all %}
                                    {% for tag in page.tags.all %}
                                        {% if tag.dictionary_entry %}
                                            <span class="badge bg-success">{{ tag.variation }}: {{ tag.dictionary_entry }}</span>
                                        {% else %}
                                            <span class="badge bg-danger">{{ tag.variation }}</span>
                                        {% endif %}
                                    {% endfor %}
                                {% endfor %}
                            </td>
                        </tr>
                        <tr>
                            <td>Open in Transkribus</td>
                            <td> <a href="{{ document.get_transkribus_url }}" target="_blank">{{ document.get_transkribus_url }}</a></td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <ul class="nav nav-tabs" id="documentTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="pages-tab" data-bs-toggle="tab" data-bs-target="#pages" type="button" role="tab" aria-controls="pages" aria-selected="true">Pages</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="metadata-tab" data-bs-toggle="tab" data-bs-target="#metadata" type="button" role="tab" aria-controls="metadata" aria-selected="false">Metadata</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="sync-history-tab" data-bs-toggle="tab" data-bs-target="#sync-history" type="button" role="tab" aria-controls="sync-history" aria-selected="false">Sync History</button>
        </li>
    </ul>
    <div class="tab-content mt-2" id="documentTabsContent">
        <div class="tab-pane fade show active" id="pages" role="tabpanel" aria-labelledby="pages-tab">
            <div class="row">
                {% for page in document.pages.all %}
                    {% if not page.is_ignored %}
                        <div class="col-8 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Page {{ page.tk_page_number }} ({{ page.tk_page_id }})</h5>
                                    <p class="card-text small">
                                        Last parsed: <span class="badge bg-secondary">{{ page.last_parsed_at }}</span>
                                        Blocks: <span class="badge bg-secondary">{{ page.parsed_data|length }}</span>
                                        Tags: <span class="badge bg-secondary">{{ page.num_tags }}</span>
                                    </p>
                                    <div class="card-text px-2 bg-light">
                                        {% for block in page.parsed_data.elements %}
                                            <span class="badge bg-info">{{ block.element_data.custom_structure.structure.type }}</span>
                                            <p class="small">
                                                {% for line in block.element_data.text_lines %}
                                                    {{ line }}<br/>
                                                {% endfor %}
                                            </p>
                                            {% if not forloop.last %}
                                                <hr/>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                    <div class="card-text px-2 bg-light">
                                        Tags:
                                        {% for tag in page.tags.all %}
                                            {% if tag.dictionary_entry %}
                                                <span class="badge bg-success">{{ tag.variation }}: {{ tag.dictionary_entry }}</span>
                                            {% else %}
                                                <span class="badge bg-danger">{{ tag.variation }}</span>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-4 mb-3">
                            <img src="{{ page.parsed_data.file.imgUrl }}" class="img-fluid img-clickable" alt="Page image">
                            <a href="{{ page.parsed_data.file.xmlUrl }}" target="_blank">Download PAGE.XML</a>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
        <div class="tab-pane fade" id="metadata" role="tabpanel" aria-labelledby="metadata-tab">
            {% render_metadata document %}
        </div>
        <div class="tab-pane fade" id="sync-history" role="tabpanel" aria-labelledby="sync-history-tab">
            <div class="card">
                <div class="card-header">
                    <h5>Document Synchronization History</h5>
                    <p class="text-muted small mb-0">Records of all Transkribus export synchronizations for this document</p>
                </div>
                <div class="card-body">
                    {% if document.sync_history.all %}
                        {% for sync in document.sync_history.all %}
                            <div class="card mb-3">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>{{ sync.synced_at|date:"Y-m-d H:i:s" }}</strong>
                                        <span class="badge
                                            {% if sync.sync_type == 'created' %}bg-success
                                            {% elif sync.sync_type == 'updated' %}bg-primary
                                            {% elif sync.sync_type == 'unchanged' %}bg-secondary
                                            {% elif sync.sync_type == 'deleted' %}bg-danger
                                            {% endif %}
                                        ">{{ sync.get_sync_type_display }}</span>
                                    </div>
                                    <small class="text-muted">by {{ sync.user.username }}</small>
                                </div>
                                <div class="card-body">
                                    {% if sync.changes %}
                                        {% if sync.changes.tags %}
                                            <h6>Tag Changes:</h6>
                                            <ul>
                                                {% if sync.changes.tags.added > 0 %}
                                                    <li><span class="badge bg-success">+{{ sync.changes.tags.added }}</span> tags added</li>
                                                {% endif %}
                                                {% if sync.changes.tags.updated > 0 %}
                                                    <li><span class="badge bg-primary">~{{ sync.changes.tags.updated }}</span> tags updated</li>
                                                {% endif %}
                                                {% if sync.changes.tags.deleted > 0 %}
                                                    <li><span class="badge bg-danger">-{{ sync.changes.tags.deleted }}</span> tags deleted</li>
                                                {% endif %}
                                                {% if sync.changes.tags.preserved_assignments > 0 %}
                                                    <li><span class="badge bg-info">{{ sync.changes.tags.preserved_assignments }}</span> dictionary assignments preserved</li>
                                                {% endif %}
                                                {% if sync.changes.tags.preserved_parked > 0 %}
                                                    <li><span class="badge bg-warning">{{ sync.changes.tags.preserved_parked }}</span> parked statuses preserved</li>
                                                {% endif %}
                                                {% if sync.changes.tags.auto_assigned > 0 %}
                                                    <li><span class="badge bg-success">{{ sync.changes.tags.auto_assigned }}</span> new tags auto-assigned</li>
                                                {% endif %}
                                            </ul>

                                            {% if sync.changes.transcription_changes %}
                                                <div class="alert alert-info" role="alert">
                                                    <strong>Note:</strong> Transcription changes detected (tag offsets shifted)
                                                </div>
                                            {% endif %}

                                            {% if sync.changes.tags.offset_shifts %}
                                                <details class="mt-2">
                                                    <summary class="text-muted small">View offset shifts ({{ sync.changes.tags.offset_shifts|length }})</summary>
                                                    <ul class="small mt-2">
                                                        {% for shift in sync.changes.tags.offset_shifts %}
                                                            <li>Line {{ shift.line }}: "{{ shift.tag }}" ({{ shift.old_offset }} â†’ {{ shift.new_offset }})</li>
                                                        {% endfor %}
                                                    </ul>
                                                </details>
                                            {% endif %}
                                        {% endif %}

                                        {% if sync.changes.pages_added or sync.changes.pages_updated or sync.changes.pages_deleted %}
                                            <h6>Page Changes:</h6>
                                            <ul>
                                                {% if sync.changes.pages_added > 0 %}
                                                    <li><span class="badge bg-success">+{{ sync.changes.pages_added }}</span> pages added</li>
                                                {% endif %}
                                                {% if sync.changes.pages_updated > 0 %}
                                                    <li><span class="badge bg-primary">~{{ sync.changes.pages_updated }}</span> pages updated</li>
                                                {% endif %}
                                                {% if sync.changes.pages_deleted > 0 %}
                                                    <li><span class="badge bg-danger">-{{ sync.changes.pages_deleted }}</span> pages deleted</li>
                                                {% endif %}
                                            </ul>
                                        {% endif %}

                                        {% if sync.changes.warnings %}
                                            <div class="alert alert-warning mt-2" role="alert">
                                                <strong>Warnings:</strong>
                                                <ul class="mb-0 mt-1">
                                                    {% for warning in sync.changes.warnings %}
                                                        <li class="small">{{ warning }}</li>
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                        {% endif %}
                                    {% else %}
                                        <p class="text-muted">No detailed changes recorded</p>
                                    {% endif %}

                                    {% if sync.task %}
                                        <div class="mt-2">
                                            <small class="text-muted">
                                                Related task: <a href="{% url 'twf:task_detail' sync.task.pk %}">{{ sync.task.title }}</a>
                                            </small>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="alert alert-info" role="alert">
                            No synchronization history available for this document yet.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block script %}
    <script type="text/javascript" src="{% static 'twf/js/handle_metadata.js' %}"></script>
{% endblock %}