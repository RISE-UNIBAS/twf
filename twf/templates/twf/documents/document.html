{% extends 'twf/base/base.html' %}
{% load static %}
{% load nav_tags %}
{% load twf_renders %}

{% block content %}

    <!-- Document Navigation -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            {% if previous_document_id %}
                <a href="{% url 'twf:view_document' previous_document_id %}" class="btn btn-outline-secondary">
                    <i class="fa fa-chevron-left me-2"></i>Previous
                </a>
            {% else %}
                <button class="btn btn-outline-secondary" disabled>
                    <i class="fa fa-chevron-left me-2"></i>Previous
                </button>
            {% endif %}
        </div>
        <div>
            <h5 class="mb-0">{{ document.title|default:document.document_id }}</h5>
        </div>
        <div>
            {% if next_document_id %}
                <a href="{% url 'twf:view_document' next_document_id %}" class="btn btn-outline-secondary">
                    Next<i class="fa fa-chevron-right ms-2"></i>
                </a>
            {% else %}
                <button class="btn btn-outline-secondary" disabled>
                    Next<i class="fa fa-chevron-right ms-2"></i>
                </button>
            {% endif %}
        </div>
    </div>

    <!-- Document Tabs -->
    <ul class="nav nav-tabs" id="documentTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="doc-metadata-tab" data-bs-toggle="tab" data-bs-target="#doc-metadata"
                    type="button" role="tab" aria-controls="doc-metadata" aria-selected="true">
                Document Metadata
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="additional-metadata-tab" data-bs-toggle="tab" data-bs-target="#additional-metadata"
                    type="button" role="tab" aria-controls="additional-metadata" aria-selected="false">
                Additional Metadata
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tags-tab" data-bs-toggle="tab" data-bs-target="#tags"
                    type="button" role="tab" aria-controls="tags" aria-selected="false">
                Tags
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="sync-history-tab" data-bs-toggle="tab" data-bs-target="#sync-history"
                    type="button" role="tab" aria-controls="sync-history" aria-selected="false">
                Sync History
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="options-tab" data-bs-toggle="tab" data-bs-target="#options"
                    type="button" role="tab" aria-controls="options" aria-selected="false">
                Options
            </button>
        </li>
    </ul>

    <div class="tab-content mt-3" id="documentTabsContent">
        <!-- Document Metadata Tab -->
        <div class="tab-pane fade show active" id="doc-metadata" role="tabpanel" aria-labelledby="doc-metadata-tab">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title mb-3">Basic Information</h5>
                    <table class="table table-sm">
                        <tr>
                            <td class="fw-bold" style="width: 200px;">Database ID / Transkribus ID</td>
                            <td>{{ document.pk }} / {{ document.document_id }}</td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Document Title</td>
                            <td>{{ document.title }}</td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Pages</td>
                            <td>
                                <span class="badge bg-primary">{{ document.pages.count }} total</span>
                                {% if excluded_count > 0 %}
                                    <span class="badge bg-secondary ms-1">{{ excluded_count }} excluded</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Status</td>
                            <td>
                                <span class="badge {% if document.status == 'open' %}bg-secondary{% elif document.status == 'reviewed' %}bg-success{% elif document.status == 'needs_tk_work' %}bg-warning{% endif %}">
                                    {{ document.get_status_display }}
                                </span>
                                {% if document.is_parked %}
                                    <span class="badge bg-info ms-1" title="Parked">⏸ Parked</span>
                                {% endif %}
                                {% if document.is_ignored %}
                                    <span class="badge bg-dark ms-1" title="Excluded from corpus">✕ Excluded</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Created</td>
                            <td>{{ document.created_at|date:"Y-m-d H:i:s" }} by {{ document.created_by }}</td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Last Modified</td>
                            <td>{{ document.modified_at|date:"Y-m-d H:i:s" }} by {{ document.modified_by }}</td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Open in Transkribus</td>
                            <td>
                                <a href="{{ document.get_transkribus_url }}" target="_blank" class="text-decoration-none">
                                    <i class="fa fa-external-link me-1"></i>View on Transkribus
                                </a>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <!-- Additional Metadata Tab -->
        <div class="tab-pane fade" id="additional-metadata" role="tabpanel" aria-labelledby="additional-metadata-tab">
            {% render_metadata document %}
        </div>

        <!-- Tags Tab -->
        <div class="tab-pane fade" id="tags" role="tabpanel" aria-labelledby="tags-tab">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Tags in Document</h5>
                </div>
                <div class="card-body">
                    {% for page in document.pages.all %}
                        {% if page.tags.all %}
                            <h6 class="mt-3 mb-2">Page {{ page.tk_page_number }}</h6>
                            <div class="mb-3">
                                {% for tag in page.tags.all %}
                                    {% if tag.dictionary_entry %}
                                        <a href="{% url 'twf:dictionaries_entry_view' tag.dictionary_entry.pk %}"
                                           class="text-decoration-none"
                                           data-bs-toggle="tooltip"
                                           title="View dictionary entry: {{ tag.dictionary_entry.label }}">
                                            <span class="badge bg-success me-1 mb-1">
                                                {{ tag.variation }}: {{ tag.dictionary_entry }}
                                            </span>
                                        </a>
                                    {% elif tag.date_variation_entry %}
                                        <span class="badge bg-success me-1 mb-1"
                                              data-bs-toggle="tooltip"
                                              title="Normalized date: {{ tag.date_variation_entry.edtf_of_normalized_variation|default:'Unknown' }}">
                                            {{ tag.variation }}: {{ tag.date_variation_entry.edtf_of_normalized_variation|default:tag.date_variation_entry }}
                                        </span>
                                    {% else %}
                                        <span class="badge bg-danger me-1 mb-1">
                                            {{ tag.variation }}
                                        </span>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    {% empty %}
                        <p class="text-muted">No tags found in this document.</p>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Sync History Tab -->
        <div class="tab-pane fade" id="sync-history" role="tabpanel" aria-labelledby="sync-history-tab">
            <div class="card">
                <div class="card-header">
                    <h5>Document Synchronization History</h5>
                    <p class="text-muted small mb-0">Records of all Transkribus export synchronizations for this document</p>
                </div>
                <div class="card-body">
                    {% if document.sync_history.all %}
                        {% for sync in document.sync_history.all %}
                            <div class="card mb-3">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>{{ sync.synced_at|date:"Y-m-d H:i:s" }}</strong>
                                        <span class="badge
                                            {% if sync.sync_type == 'created' %}bg-success
                                            {% elif sync.sync_type == 'updated' %}bg-primary
                                            {% elif sync.sync_type == 'unchanged' %}bg-secondary
                                            {% elif sync.sync_type == 'deleted' %}bg-danger
                                            {% endif %}
                                        ">{{ sync.get_sync_type_display }}</span>
                                    </div>
                                    <small class="text-muted">by {{ sync.user.username }}</small>
                                </div>
                                <div class="card-body">
                                    {% if sync.changes %}
                                        {% if sync.changes.tags %}
                                            <h6>Tag Changes:</h6>
                                            <ul>
                                                {% if sync.changes.tags.added > 0 %}
                                                    <li><span class="badge bg-success">+{{ sync.changes.tags.added }}</span> tags added</li>
                                                {% endif %}
                                                {% if sync.changes.tags.updated > 0 %}
                                                    <li><span class="badge bg-primary">~{{ sync.changes.tags.updated }}</span> tags updated</li>
                                                {% endif %}
                                                {% if sync.changes.tags.deleted > 0 %}
                                                    <li><span class="badge bg-danger">-{{ sync.changes.tags.deleted }}</span> tags deleted</li>
                                                {% endif %}
                                                {% if sync.changes.tags.preserved_assignments > 0 %}
                                                    <li><span class="badge bg-info">{{ sync.changes.tags.preserved_assignments }}</span> dictionary assignments preserved</li>
                                                {% endif %}
                                                {% if sync.changes.tags.preserved_parked > 0 %}
                                                    <li><span class="badge bg-warning">{{ sync.changes.tags.preserved_parked }}</span> parked statuses preserved</li>
                                                {% endif %}
                                                {% if sync.changes.tags.auto_assigned > 0 %}
                                                    <li><span class="badge bg-success">{{ sync.changes.tags.auto_assigned }}</span> new tags auto-assigned</li>
                                                {% endif %}
                                            </ul>

                                            {% if sync.changes.transcription_changes %}
                                                <div class="alert alert-info" role="alert">
                                                    <strong>Note:</strong> Transcription changes detected (tag offsets shifted)
                                                </div>
                                            {% endif %}

                                            {% if sync.changes.tags.offset_shifts %}
                                                <details class="mt-2">
                                                    <summary class="text-muted small">View offset shifts ({{ sync.changes.tags.offset_shifts|length }})</summary>
                                                    <ul class="small mt-2">
                                                        {% for shift in sync.changes.tags.offset_shifts %}
                                                            <li>Line {{ shift.line }}: "{{ shift.tag }}" ({{ shift.old_offset }} → {{ shift.new_offset }})</li>
                                                        {% endfor %}
                                                    </ul>
                                                </details>
                                            {% endif %}
                                        {% endif %}

                                        {% if sync.changes.pages_added or sync.changes.pages_updated or sync.changes.pages_deleted %}
                                            <h6>Page Changes:</h6>
                                            <ul>
                                                {% if sync.changes.pages_added > 0 %}
                                                    <li><span class="badge bg-success">+{{ sync.changes.pages_added }}</span> pages added</li>
                                                {% endif %}
                                                {% if sync.changes.pages_updated > 0 %}
                                                    <li><span class="badge bg-primary">~{{ sync.changes.pages_updated }}</span> pages updated</li>
                                                {% endif %}
                                                {% if sync.changes.pages_deleted > 0 %}
                                                    <li><span class="badge bg-danger">-{{ sync.changes.pages_deleted }}</span> pages deleted</li>
                                                {% endif %}
                                            </ul>
                                        {% endif %}

                                        {% if sync.changes.warnings %}
                                            <div class="alert alert-warning mt-2" role="alert">
                                                <strong>Warnings:</strong>
                                                <ul class="mb-0 mt-1">
                                                    {% for warning in sync.changes.warnings %}
                                                        <li class="small">{{ warning }}</li>
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                        {% endif %}
                                    {% else %}
                                        <p class="text-muted">No detailed changes recorded</p>
                                    {% endif %}

                                    {% if sync.task %}
                                        <div class="mt-2">
                                            <small class="text-muted">
                                                Related task: <a href="{% url 'twf:task_detail' sync.task.pk %}">{{ sync.task.title }}</a>
                                            </small>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="alert alert-info" role="alert">
                            No synchronization history available for this document yet.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Options Tab -->
        <div class="tab-pane fade" id="options" role="tabpanel" aria-labelledby="options-tab">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Document Options</h5>
                </div>
                <div class="card-body">
                    <!-- Update API Metadata Section -->
                    <div class="mb-4">
                        <h6 class="border-bottom pb-2 mb-3">Metadata Management</h6>
                        <button type="button" class="btn btn-outline-primary"
                                onclick="updatePageMetadata({{ document.document_id }})"
                                title="Refresh metadata from Transkribus API">
                            <i class="fa fa-refresh me-1"></i>Update API Metadata
                        </button>
                        <p class="text-muted small mt-2">Fetch the latest metadata from Transkribus API for this document.</p>
                    </div>

                    <!-- Document Status and Remarks Form -->
                    <form method="POST" action="{% url 'twf:update_document_options' document.pk %}">
                        {% csrf_token %}

                        <h6 class="border-bottom pb-2 mb-3">Status & Workflow</h6>

                        <!-- Status Selection -->
                        <div class="mb-3">
                            <label for="status" class="form-label fw-bold">Document Status</label>
                            <select class="form-select" id="status" name="status">
                                {% for value, label in document.STATUS_CHOICES %}
                                    <option value="{{ value }}" {% if document.status == value %}selected{% endif %}>
                                        {{ label }}
                                    </option>
                                {% endfor %}
                            </select>
                            <div class="form-text">Current status determines how the document is processed in workflows.</div>
                        </div>

                        <!-- Is Parked Checkbox -->
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="is_parked" name="is_parked"
                                       value="true" {% if document.is_parked %}checked{% endif %}>
                                <label class="form-check-label" for="is_parked">
                                    <strong>Parked</strong> - Temporarily exclude from active workflows
                                </label>
                            </div>
                            <div class="form-text">Parked documents are set aside for later processing without being deleted.</div>
                        </div>

                        <!-- Workflow Remarks -->
                        <div class="mb-3">
                            <label for="workflow_remarks" class="form-label fw-bold">Workflow Remarks</label>
                            <textarea class="form-control" id="workflow_remarks" name="workflow_remarks"
                                      rows="5" placeholder="Add notes about this document's workflow status...">{{ document.workflow_remarks }}</textarea>
                            <div class="form-text">Internal notes about review status, issues, or special handling requirements.</div>
                        </div>

                        <!-- Submit Button -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="submit" class="btn btn-primary">
                                <i class="fa fa-save me-1"></i>Save Options
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Pages Section -->
    <div class="mt-4">
        {% if excluded_count > 0 %}
            <div class="alert alert-info mb-3">
                <i class="fa fa-info-circle me-2"></i>
                <strong>{{ excluded_count }} page(s) excluded:</strong>
                {% for page in excluded_pages %}
                    <span class="badge bg-secondary ms-1">Page {{ page.tk_page_number }}</span>
                {% endfor %}
            </div>
        {% endif %}

        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3>Pages</h3>
            <div class="btn-group" role="group" aria-label="Page view mode">
                <input type="radio" class="btn-check" name="pageViewMode" id="viewFull" autocomplete="off" checked>
                <label class="btn btn-outline-primary btn-sm" for="viewFull" onclick="togglePageView('full')">
                    <i class="fa fa-expand me-1"></i>Full View
                </label>
                <input type="radio" class="btn-check" name="pageViewMode" id="viewCompact" autocomplete="off">
                <label class="btn btn-outline-primary btn-sm" for="viewCompact" onclick="togglePageView('compact')">
                    <i class="fa fa-compress me-1"></i>Compact View
                </label>
            </div>
        </div>

        <!-- Full View -->
        <div id="fullView" class="page-view">
            {% for page in document.pages.all %}
                {% if not page.is_ignored %}
                    <div class="row mb-4 page-full-item">
                        <div class="col-8">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">Page {{ page.tk_page_number }} ({{ page.tk_page_id }})</h5>
                                    <div>
                                        <a href="{{ page.parsed_data.file.xmlUrl }}" target="_blank"
                                           class="btn btn-sm btn-outline-secondary me-1"
                                           data-bs-toggle="tooltip" title="Download PAGE XML">
                                            <i class="fa fa-download"></i> XML
                                        </a>
                                        <a href="{{ page.get_transkribus_url }}" target="_blank"
                                           class="btn btn-sm btn-outline-primary"
                                           data-bs-toggle="tooltip" title="Open on Transkribus">
                                            <i class="fa fa-external-link"></i> Transkribus
                                        </a>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <p class="card-text small mb-3">
                                        Last parsed: <span class="badge bg-secondary">{{ page.last_parsed_at }}</span>
                                        Blocks: <span class="badge bg-secondary">{{ page.parsed_data|length }}</span>
                                        Tags: <span class="badge bg-secondary">{{ page.num_tags }}</span>
                                    </p>

                                    <!-- Page Tabs -->
                                    <ul class="nav nav-tabs" id="pageTabs{{ page.pk }}" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link active" id="content-tab-{{ page.pk }}" data-bs-toggle="tab"
                                                    data-bs-target="#content-{{ page.pk }}" type="button" role="tab"
                                                    aria-controls="content-{{ page.pk }}" aria-selected="true">
                                                Page Content
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="metadata-tab-{{ page.pk }}" data-bs-toggle="tab"
                                                    data-bs-target="#metadata-{{ page.pk }}" type="button" role="tab"
                                                    aria-controls="metadata-{{ page.pk }}" aria-selected="false">
                                                Page Metadata
                                            </button>
                                        </li>
                                    </ul>

                                    <div class="tab-content mt-3" id="pageTabsContent{{ page.pk }}">
                                        <!-- Page Content Tab -->
                                        <div class="tab-pane fade show active" id="content-{{ page.pk }}" role="tabpanel"
                                             aria-labelledby="content-tab-{{ page.pk }}">
                                            <div class="card-text px-2 bg-light">
                                                {% load twf_filters %}
                                                {% for block in page|mark_tags_inline %}
                                                    <span class="badge bg-info">{{ block.structure_type }}</span>
                                                    <p class="small">
                                                        {% for line in block.text_lines %}
                                                            {{ line }}<br/>
                                                        {% endfor %}
                                                    </p>
                                                    {% if not forloop.last %}
                                                        <hr/>
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                        </div>

                                        <!-- Page Metadata Tab -->
                                        <div class="tab-pane fade" id="metadata-{{ page.pk }}" role="tabpanel"
                                             aria-labelledby="metadata-tab-{{ page.pk }}">
                                            {% render_metadata page %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-4">
                            <img src="{{ page.parsed_data.file.imgUrl }}" class="img-fluid img-clickable" alt="Page image">
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>

        <!-- Compact View (Accordion) -->
        <div id="compactView" class="page-view" style="display: none;">
            <div class="accordion" id="pagesAccordion">
                {% for page in document.pages.all %}
                    {% if not page.is_ignored %}
                        <div class="accordion-item page-compact-item">
                            <h2 class="accordion-header" id="heading{{ page.pk }}">
                                <button class="accordion-button collapsed d-flex justify-content-between" type="button"
                                        data-bs-toggle="collapse" data-bs-target="#collapse{{ page.pk }}"
                                        aria-expanded="false" aria-controls="collapse{{ page.pk }}">
                                    <span>
                                        <strong>Page {{ page.tk_page_number }}</strong>
                                        <span class="ms-2 text-muted small">
                                            (Blocks: {{ page.parsed_data|length }}, Tags: {{ page.num_tags }})
                                        </span>
                                    </span>
                                    <span class="ms-auto me-3">
                                        <a href="{{ page.parsed_data.file.xmlUrl }}" target="_blank"
                                           class="btn btn-sm btn-outline-secondary me-1"
                                           onclick="event.stopPropagation()"
                                           data-bs-toggle="tooltip" title="Download PAGE XML">
                                            <i class="fa fa-download"></i> XML
                                        </a>
                                        <a href="{{ page.get_transkribus_url }}" target="_blank"
                                           class="btn btn-sm btn-outline-primary"
                                           onclick="event.stopPropagation()"
                                           data-bs-toggle="tooltip" title="Open on Transkribus">
                                            <i class="fa fa-external-link"></i> Transkribus
                                        </a>
                                    </span>
                                </button>
                            </h2>
                            <div id="collapse{{ page.pk }}" class="accordion-collapse collapse"
                                 aria-labelledby="heading{{ page.pk }}" data-bs-parent="#pagesAccordion">
                                <div class="accordion-body">
                                    <p class="small mb-3">
                                        Last parsed: <span class="badge bg-secondary">{{ page.last_parsed_at }}</span>
                                    </p>

                                    <!-- Page Tabs -->
                                    <ul class="nav nav-tabs" id="pageTabsCompact{{ page.pk }}" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link active" id="content-tab-compact-{{ page.pk }}" data-bs-toggle="tab"
                                                    data-bs-target="#content-compact-{{ page.pk }}" type="button" role="tab"
                                                    aria-controls="content-compact-{{ page.pk }}" aria-selected="true">
                                                Page Content
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="metadata-tab-compact-{{ page.pk }}" data-bs-toggle="tab"
                                                    data-bs-target="#metadata-compact-{{ page.pk }}" type="button" role="tab"
                                                    aria-controls="metadata-compact-{{ page.pk }}" aria-selected="false">
                                                Page Metadata
                                            </button>
                                        </li>
                                    </ul>

                                    <div class="tab-content mt-3" id="pageTabsContentCompact{{ page.pk }}">
                                        <!-- Page Content Tab -->
                                        <div class="tab-pane fade show active" id="content-compact-{{ page.pk }}" role="tabpanel"
                                             aria-labelledby="content-tab-compact-{{ page.pk }}">
                                            <div class="row">
                                                <div class="col-8">
                                                    <div class="px-2 bg-light">
                                                        {% load twf_filters %}
                                                        {% for block in page|mark_tags_inline %}
                                                            <span class="badge bg-info">{{ block.structure_type }}</span>
                                                            <p class="small">
                                                                {% for line in block.text_lines %}
                                                                    {{ line }}<br/>
                                                                {% endfor %}
                                                            </p>
                                                            {% if not forloop.last %}
                                                                <hr/>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                                <div class="col-4">
                                                    <img src="{{ page.parsed_data.file.imgUrl }}" class="img-fluid img-clickable" alt="Page image">
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Page Metadata Tab -->
                                        <div class="tab-pane fade" id="metadata-compact-{{ page.pk }}" role="tabpanel"
                                             aria-labelledby="metadata-tab-compact-{{ page.pk }}">
                                            {% render_metadata page %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
{% endblock %}

{% block script %}
    <script type="text/javascript" src="{% static 'twf/js/handle_metadata.js' %}"></script>
    <script type="text/javascript">
        function updatePageMetadata(documentId) {
            if (!confirm('This will fetch the latest metadata from Transkribus API for this document. Continue?')) {
                return;
            }

            const url = "/celery/transkribus/enrich/document/{{ document.pk }}/";

            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    force: true
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Metadata update started! Task ID: ' + data.task_id);
                    window.location.reload();
                } else {
                    alert('Error starting task: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to start metadata update task');
            });
        }

        function togglePageView(mode) {
            const fullView = document.getElementById('fullView');
            const compactView = document.getElementById('compactView');

            if (mode === 'full') {
                fullView.style.display = 'block';
                compactView.style.display = 'none';
            } else {
                fullView.style.display = 'none';
                compactView.style.display = 'block';
            }
        }

        // Initialize tooltips
        document.addEventListener('DOMContentLoaded', function() {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });

        // Keyboard navigation for documents (Left/Right arrow keys)
        document.addEventListener('keydown', function(event) {
            // Ignore if user is typing in an input/textarea
            if (event.target.matches('input, textarea, select')) {
                return;
            }

            {% if previous_document_id %}
            if (event.key === 'ArrowLeft') {
                window.location.href = "{% url 'twf:view_document' previous_document_id %}";
            }
            {% endif %}

            {% if next_document_id %}
            if (event.key === 'ArrowRight') {
                window.location.href = "{% url 'twf:view_document' next_document_id %}";
            }
            {% endif %}
        });
    </script>
{% endblock %}
