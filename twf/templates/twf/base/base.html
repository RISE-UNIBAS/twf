{% load static %}
{% load twf_permissions %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}TWF - {{ project.title }}{% endblock %}</title>
    <link rel="icon" type="image/x-icon" href="{% static 'twf/images/favicon.ico' %}">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="{% static 'twf/css/twf.css' %}" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>
    <script src="{% static 'twf/js/celery_task_monitor.js' %}"></script>
    <script src="{% static 'twf/js/handle_modals.js' %}"></script>
    <script src="{% static 'twf/js/help_overlay.js' %}"></script>
    {% block css %}
    {% endblock %}
</head>
<body data-page="{{ request.resolver_match.view_name }}">

    <header>
       {% include 'twf/base/navigation.html' %}
    </header>

    <main>
        <div class="container-fluid w-100 p-0 border">
            
            <div class="d-flex" style="height: 100%;">
                <div class="bg-dark p-3" id="sidebar-container">
                    <button id="sidebarToggle" class="btn btn-light btn-sm mb-2">
                        <i class="fas fa-bars"></i>
                    </button>
                    <nav id="sidebarMenu" class="sidebar">
                        {% for group in context_nav.groups %}
                            <div class="border rounded bg-light my-3">
                                <p class="text-center" style="font-weight: bold">{{ group.name }}</p>
                                <ul class="nav flex-column">
                                    {% for option in group.options %}
                                        {% if option.url == request.path or request.path in option.active_on %}
                                            <li class="nav-item small border rounded mx-1 mb-1 bg-dark">
                                                <a class="nav-link px-2 py-1 text-light" href="{{ option.url }}">{{ option.value }}</a>
                                            </li>
                                        {% else %}
                                            <li class="nav-item small border rounded mx-1 mb-1">
                                                <a class="nav-link px-2 py-1 text-dark" href="{{ option.url }}">{{ option.value }}</a>
                                            </li>
                                        {% endif %}
                                    {% endfor %}
                                </ul>
                            </div>
                        {% endfor %}
                    </nav>
                </div>
                <div id="content-container" class="flex-grow-1 bg-dark">
                    <h1>{{ page_title }}</h1>
                    {% if messages %}
                        <div class="messages">
                            {% for message in messages %}
                                <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %}" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close float-end" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                    {% if context_sub_nav %}
                        <div class="border rounded bg-light mt-0 p-3">
                            <div class="row">
                                <div class="col-9">
                                    {% block sub_content %}
                                    {% endblock %}
                                </div>
                                <div class="col-3">
                                    <div class="border">
                                        <p class="text-center" style="font-weight: bold">Options</p>
                                        <ul class="nav flex-column">
                                            {% for option in context_sub_nav.options %}
                                                {% user_has_permission request.user.profile option.permission project as has_permission %}
                                                {% if has_permission %}
                                                    {% if option.url == request.path %}
                                                        <li class="nav-item small border rounded mx-1 mb-1 bg-dark">
                                                            <a class="nav-link px-2 py-1 text-light" href="{{ option.url }}">{{ option.value }}</a>
                                                        </li>
                                                    {% else %}
                                                        <li class="nav-item small border rounded  mx-1 mb-1">
                                                            <a class="nav-link px-2 py-1 text-dark" href="{{ option.url }}">{{ option.value }}</a>
                                                        </li>
                                                    {% endif %}
                                                {% endif %}
                                            {% endfor %}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                         </div>
                    {% else %}
                        {% block content %}
                        {% endblock %}
                    {% endif %}
                </div>
            </div>
        </div>
    
        {% include 'twf/base/confirm_modal.html' %}
        {% include 'twf/base/confirm_modal_danger.html' %}
        {% include 'twf/base/help_overlay.html' %}
    </main>

    <footer class="footer">
        <div class="container-fluid">
            <div class="row justify-content-between align-items-center">
                <div class="col-3 text-start">
                    {% if user.is_authenticated %}
                        Logged in as <strong>{{ user }}</strong>
                    {% endif %}
                </div>
                <div class="col-3 text-center">
                    <span>Selected Project: <strong>{{ project }}</strong></span> <!-- Selected project -->
                </div>
                <div class="col-3 text-center">
                    <span>TWF Version: <strong>{{ version }}</strong></span> <!-- Selected project -->
                </div>
                <div class="col-3 text-right">
                    {% if user.is_authenticated %}
                        <a href="{% url 'twf:user_logout' %}" class="btn btn-dark">Logout</a> <!-- Logout button -->
                    {% endif %}
                </div>
            </div>
        </div>
    </footer>

    <!-- Enable Bootstrap tooltips -->
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });
    </script>

    <!-- Enable sidebar collapse -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const sidebarContainer = document.getElementById("sidebar-container");
            const sidebarMenu = document.getElementById("sidebarMenu");
            const sidebarToggle = document.getElementById("sidebarToggle");
            const contentContainer = document.getElementById("content-container");

            // Load saved state from localStorage
            const isCollapsed = localStorage.getItem("sidebar-collapsed") === "true";

            if (isCollapsed) {
                sidebarContainer.classList.add("collapsed");
                sidebarMenu.style.display = "none";
                contentContainer.style.width = "calc(100% - 50px)"; // Adjust content width
            } else {
                contentContainer.style.width = "calc(100% - 250px)"; // Normal width
            }

            // Sidebar Toggle Button Click Event
            sidebarToggle.addEventListener("click", function () {
                const isCurrentlyCollapsed = sidebarContainer.classList.contains("collapsed");

                if (isCurrentlyCollapsed) {
                    sidebarContainer.classList.remove("collapsed");
                    sidebarMenu.style.display = "block";
                    contentContainer.style.width = "calc(100% - 250px)";
                    localStorage.setItem("sidebar-collapsed", "false");
                } else {
                    sidebarContainer.classList.add("collapsed");
                    sidebarMenu.style.display = "none";
                    contentContainer.style.width = "calc(100% - 50px)";
                    localStorage.setItem("sidebar-collapsed", "true");
                }
            });
        });
    </script>

    {% block script %}
    {% endblock %}
</body>
</html>